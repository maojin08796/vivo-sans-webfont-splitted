{"version":3,"file":"genCommanderCode.js","sources":["../../src/adapter/genCommanderCode.ts"],"sourcesContent":["import protobuf from 'protobufjs';\nimport fs from 'fs';\nimport { Adapter } from '../cli.js';\n\n/**\n * @zh 生成 commander 参数定义\n * @en Generate commander parameter definitions\n */\nexport const genCommanderCode: Adapter = (\n    filePath: string,\n    messageName: string,\n) => {\n    const buf = fs.readFileSync(filePath, 'utf-8');\n    const proto = protobuf.parse(buf, {\n        alternateCommentMode: true,\n    });\n    const defaultCommandName = 'run';\n    const template = proto.root.lookup(messageName)!;\n    // @ts-ignore\n    const { fields, nested } = template.toJSON({ keepComments: true });\n    // console.log(fields);\n    const importHeader = `/* automatically generated by proto-to-cli */\nimport { toInt, toFloat, toFile, toBoolean, HandleRepeated } from \"proto-to-cli/dist/parser.js\";\nimport { Command } from 'commander';\nconst run = new Command(\"${defaultCommandName}\");\n`;\n\n    const shortCode = new Set();\n    const params = `run` + createFlatDefine(fields).join('\\n    ');\n\n    function createFlatDefine(fields: any, parentKey = ''): string[] {\n        return Object.entries<any>(fields).flatMap(([key, value]): string[] => {\n            let isOption = value.options?.proto3_optional ?? false;\n            if (parentKey) isOption = true;\n            const comment = value.comment ?? '';\n            const defaultValue = null;\n            if (nested && Object.keys(nested).includes(value.type)) {\n                // console.log(value.type);\n                return createFlatDefine(\n                    nested[value.type].fields,\n                    key + '.',\n                ) as string[];\n            }\n            let parser;\n            let placeholder = ` <${value.type}>`;\n            if (value.type.startsWith('int')) {\n                parser = 'toInt';\n            } else if (value.type.startsWith('float')) {\n                parser = 'toFloat';\n            } else if (value.type.startsWith('bytes')) {\n                parser = 'toFile';\n            } else if (value.type === 'bool') {\n                parser = 'toBoolean';\n            }\n            if (value.rule === 'repeated' && parser) {\n                parser = `HandleRepeated(${parser})`;\n                isOption = true;\n            }\n            const longName = parentKey + key;\n            let mayShortName = '';\n            if (!parentKey && !shortCode.has(longName[0])) {\n                mayShortName = '-' + longName[0] + ',';\n                shortCode.add(longName[0]);\n            }\n            return [\n                `.${\n                    isOption ? 'option' : 'requiredOption'\n                }('${mayShortName}--${longName}${placeholder}',\"${comment}\"${\n                    parser ? ',' + parser : ''\n                }${defaultValue ? ',' + defaultValue : ''})`,\n            ];\n        });\n    }\n    return (\n        importHeader +\n        params +\n        `\\nexport const getCliParams = (argv: string[], extraFn?: (cm: Command, run: Command) => void) => {\n    const program = new Command();\n    program.addCommand(run, { isDefault: true });\n    extraFn && extraFn(program, run);\n    return program.parse(argv);\n};`\n    );\n};\n"],"names":["fields"],"mappings":"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"}