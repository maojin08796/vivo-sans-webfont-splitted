{"version":3,"file":"genClapCode.mjs","sources":["../../src/adapter/genClapCode.ts"],"sourcesContent":["import protobuf from 'protobufjs';\nimport fs from 'fs';\nimport { Adapter } from '../cli.js';\nimport { snakeCase } from 'change-case';\n\n/**\n * @zh 生成 clap 参数定义\n * @en Generate clap parameter definitions\n */\nexport const genClapCode: Adapter = (filePath: string, messageName: string) => {\n    const buf = fs.readFileSync(filePath, 'utf-8');\n    const proto = protobuf.parse(buf, {\n        alternateCommentMode: true,\n    });\n    const template = proto.root.lookup(messageName)!;\n    // @ts-ignore\n    const { fields, nested } = template.toJSON({ keepComments: true });\n    // console.log(fields);\n    const importHeader = `/* automatically generated by proto-to-cli */\nuse clap::Parser;\nuse std::path::PathBuf;\n#[derive(Parser, Debug)]\n#[command(version, about, long_about = None)]\n#[clap(name = \"${messageName}\")]\npub struct ${messageName} {\n`;\n\n    const shortCode = new Set();\n    const params = createFlatDefine(fields).join('\\n');\n    function createFlatDefine(fields: any, parentKey = ''): string[] {\n        return Object.entries<any>(fields).flatMap(([key, value]): string[] => {\n            let isOption = value.options?.proto3_optional ?? false;\n            if (parentKey) isOption = true;\n            const comment = value.comment ?? '';\n            const defaultValue = null;\n            if (nested && Object.keys(nested).includes(value.type)) {\n                // console.log(value.type);\n                return createFlatDefine(\n                    nested[value.type].fields,\n                    key + '.',\n                ) as string[];\n            }\n\n            const typeMap: any = {\n                // proto 类型: Rust 类型\n                bytes: 'PathBuf',\n                string: 'String',\n                int32: 'i32',\n                int64: 'i64',\n                uint32: 'u32',\n                uint64: 'u64',\n                sint32: 'i32',\n                sint64: 'i64',\n                fixed32: 'u32',\n                fixed64: 'u64',\n                sfixed32: 'i32',\n                sfixed64: 'i64',\n                bool: 'bool',\n                float: 'f32',\n                double: 'f64',\n                // 对于枚举类型，可以使用自定义枚举名\n                // enum: 'CustomEnum',\n            };\n\n            const toRepeated = (val: string) =>\n                value.rule === 'repeated' ? `Vec<${val}>` : val;\n            let placeholder = toRepeated(\n                `${typeMap[value.type] ?? value.type}`,\n            );\n\n            const longName = parentKey + key;\n            let mayShortName = '';\n            if (!parentKey && !shortCode.has(longName[0])) {\n                mayShortName = longName[0];\n                shortCode.add(longName[0]);\n            }\n            return [\n                `    #[arg(${[\n                    `long = \"${longName}\"`,\n                    mayShortName ? `short = '${mayShortName}'` : '',\n                    `help = \"${comment}\"`,\n                    defaultValue ? `default_value = \"${defaultValue}\"` : '',\n                    // value.type === 'bytes' ? `value_parser = parse_bytes` : '',\n                ]\n                    .filter(Boolean)\n                    .map((i) => '\\n        ' + i)\n                    .join(',')}\n    )]\n    pub ${snakeCase(capitalizeAfterDot(longName))}: ${\n        isOption ? `Option<${placeholder}>` : placeholder\n    },\\n`,\n            ];\n        });\n    }\n    return (\n        importHeader + params + `\\n}`\n        // `fn parse_bytes(input: &str) -> Result<Vec<u8>, String> {\n        //     let f = std::fs::read(std::path::Path::new(input));\n        //     match f {\n        //         Ok(file) => Ok(file),\n        //         Err(e) => Err(String::from(\"Parse File Error\")),\n        //     }\n        // }`\n    );\n};\nfunction capitalizeAfterDot(input: string): string {\n    return input.replace(/(\\.)([a-z])/g, (match, p1, p2) => {\n        return p2.toUpperCase();\n    });\n}\n"],"names":["fields"],"mappings":";;;;AASa,MAAA,WAAA,GAAuB,CAAC,QAAA,EAAkB,WAAwB,KAAA;AAC3E,EAAA,MAAM,GAAM,GAAA,EAAA,CAAG,YAAa,CAAA,QAAA,EAAU,OAAO,CAAA;AAC7C,EAAM,MAAA,KAAA,GAAQ,QAAS,CAAA,KAAA,CAAM,GAAK,EAAA;AAAA,IAC9B,oBAAsB,EAAA;AAAA,GACzB,CAAA;AACD,EAAA,MAAM,QAAW,GAAA,KAAA,CAAM,IAAK,CAAA,MAAA,CAAO,WAAW,CAAA;AAE9C,EAAM,MAAA,EAAE,QAAQ,MAAO,EAAA,GAAI,SAAS,MAAO,CAAA,EAAE,YAAc,EAAA,IAAA,EAAM,CAAA;AAEjE,EAAA,MAAM,YAAe,GAAA,CAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAAA,EAKR,WAAW,CAAA;AAAA,WAAA,EACf,WAAW,CAAA;AAAA,CAAA;AAGpB,EAAM,MAAA,SAAA,uBAAgB,GAAI,EAAA;AAC1B,EAAA,MAAM,MAAS,GAAA,gBAAA,CAAiB,MAAM,CAAA,CAAE,KAAK,IAAI,CAAA;AACjD,EAAS,SAAA,gBAAA,CAAiBA,OAAa,EAAA,SAAA,GAAY,EAAc,EAAA;AAC7D,IAAO,OAAA,MAAA,CAAO,QAAaA,OAAM,CAAA,CAAE,QAAQ,CAAC,CAAC,GAAK,EAAA,KAAK,CAAgB,KAAA;AACnE,MAAI,IAAA,QAAA,GAAW,KAAM,CAAA,OAAA,EAAS,eAAmB,IAAA,KAAA;AACjD,MAAA,IAAI,WAAsB,QAAA,GAAA,IAAA;AAC1B,MAAM,MAAA,OAAA,GAAU,MAAM,OAAW,IAAA,EAAA;AAEjC,MAAI,IAAA,MAAA,IAAU,OAAO,IAAK,CAAA,MAAM,EAAE,QAAS,CAAA,KAAA,CAAM,IAAI,CAAG,EAAA;AAEpD,QAAO,OAAA,gBAAA;AAAA,UACH,MAAA,CAAO,KAAM,CAAA,IAAI,CAAE,CAAA,MAAA;AAAA,UACnB,GAAM,GAAA;AAAA,SACV;AAAA;AAGJ,MAAA,MAAM,OAAe,GAAA;AAAA;AAAA,QAEjB,KAAO,EAAA,SAAA;AAAA,QACP,MAAQ,EAAA,QAAA;AAAA,QACR,KAAO,EAAA,KAAA;AAAA,QACP,KAAO,EAAA,KAAA;AAAA,QACP,MAAQ,EAAA,KAAA;AAAA,QACR,MAAQ,EAAA,KAAA;AAAA,QACR,MAAQ,EAAA,KAAA;AAAA,QACR,MAAQ,EAAA,KAAA;AAAA,QACR,OAAS,EAAA,KAAA;AAAA,QACT,OAAS,EAAA,KAAA;AAAA,QACT,QAAU,EAAA,KAAA;AAAA,QACV,QAAU,EAAA,KAAA;AAAA,QACV,IAAM,EAAA,MAAA;AAAA,QACN,KAAO,EAAA,KAAA;AAAA,QACP,MAAQ,EAAA;AAAA;AAAA;AAAA,OAGZ;AAEA,MAAM,MAAA,UAAA,GAAa,CAAC,GAChB,KAAA,KAAA,CAAM,SAAS,UAAa,GAAA,CAAA,IAAA,EAAO,GAAG,CAAM,CAAA,CAAA,GAAA,GAAA;AAChD,MAAA,IAAI,WAAc,GAAA,UAAA;AAAA,QACd,GAAG,OAAQ,CAAA,KAAA,CAAM,IAAI,CAAA,IAAK,MAAM,IAAI,CAAA;AAAA,OACxC;AAEA,MAAA,MAAM,WAAW,SAAY,GAAA,GAAA;AAC7B,MAAA,IAAI,YAAe,GAAA,EAAA;AACnB,MAAI,IAAA,CAAC,aAAa,CAAC,SAAA,CAAU,IAAI,QAAS,CAAA,CAAC,CAAC,CAAG,EAAA;AAC3C,QAAA,YAAA,GAAe,SAAS,CAAC,CAAA;AACzB,QAAU,SAAA,CAAA,GAAA,CAAI,QAAS,CAAA,CAAC,CAAC,CAAA;AAAA;AAE7B,MAAO,OAAA;AAAA,QACH,CAAa,UAAA,EAAA;AAAA,UACT,WAAW,QAAQ,CAAA,CAAA,CAAA;AAAA,UACnB,YAAA,GAAe,CAAY,SAAA,EAAA,YAAY,CAAM,CAAA,CAAA,GAAA,EAAA;AAAA,UAC7C,WAAW,OAAO,CAAA,CAAA,CAAA;AAAA,UACmC;AAAA;AAAA,SAGpD,CAAA,MAAA,CAAO,OAAO,CAAA,CACd,GAAI,CAAA,CAAC,CAAM,KAAA,YAAA,GAAe,CAAC,CAAA,CAC3B,IAAK,CAAA,GAAG,CAAC;AAAA;AAAA,QAEpB,EAAA,SAAA,CAAU,kBAAmB,CAAA,QAAQ,CAAC,CAAC,KACzC,QAAW,GAAA,CAAA,OAAA,EAAU,WAAW,CAAA,CAAA,CAAA,GAAM,WAC1C,CAAA;AAAA;AAAA,OACQ;AAAA,KACH,CAAA;AAAA;AAEL,EAAA,OACI,eAAe,MAAS,GAAA;AAAA,CAAA,CAAA;AAShC;AACA,SAAS,mBAAmB,KAAuB,EAAA;AAC/C,EAAA,OAAO,MAAM,OAAQ,CAAA,cAAA,EAAgB,CAAC,KAAA,EAAO,IAAI,EAAO,KAAA;AACpD,IAAA,OAAO,GAAG,WAAY,EAAA;AAAA,GACzB,CAAA;AACL;;;;"}