{"version":3,"file":"index.js","sources":["../../src/bun/index.ts"],"sourcesContent":["/** @ts-ignore */\nimport { dlopen, FFIType, ptr, JSCallback, toArrayBuffer } from 'bun:ffi';\nimport path from 'path';\nimport { FontSplitProps } from '../interface.js';\nimport { getBinName, matchPlatform } from '../load.js';\nimport { isMusl } from '../node/isMusl.js';\nimport { createAPI } from '../createAPI.js';\nexport * from '../interface.js';\nexport * from '../createAPI.js';\n\nlet binPath = process.env.CN_FONT_SPLIT_BIN;\nif (!binPath) {\n    binPath = path.resolve(\n        __dirname,\n        '../' +\n            getBinName(matchPlatform(process.platform, process.arch, isMusl)),\n    );\n    // console.log(binPath);\n    // throw new Error('CN_FONT_SPLIT_BIN is undefined!');\n}\nconst {\n    symbols: { font_split },\n    close,\n} = dlopen(binPath, {\n    font_split: {\n        args: [FFIType.ptr, FFIType.usize, FFIType.callback],\n        returns: FFIType.void,\n    },\n});\nconst createCallback = (cb: (data: Uint8Array) => void) =>\n    new JSCallback(\n        (ptr: any, length: BigInt) => {\n            const data = new Uint8Array(\n                toArrayBuffer(ptr, 0, Number(length)).slice(),\n                0,\n                Number(length),\n            );\n            cb(data);\n        },\n        {\n            returns: FFIType.void,\n            args: [FFIType.ptr, FFIType.usize],\n        },\n    ).ptr;\nexport const fontSplit = createAPI((buffer, length, cb) => {\n    return font_split(ptr(buffer), length, cb);\n}, createCallback);\n"],"names":["binPath","path","getBinName","matchPlatform","isMusl","font_split","close","dlopen","FFIType","createCallback","cb","JSCallback","ptr","length","data","toArrayBuffer","fontSplit","createAPI","buffer"],"mappings":"gRAUA,IAAIA,EAAU,QAAQ,IAAI,kBACrBA,IACDA,EAAUC,EAAK,QACX,UACA,MACIC,EAAAA,WAAWC,gBAAc,QAAQ,SAAU,QAAQ,KAAMC,QAAM,CAAC,CAAA,GAK5E,KAAM,CACF,QAAS,CAAE,WAAAC,CAAA,EACX,MAAAC,CACJ,EAAIC,EAAAA,OAAOP,EAAS,CAChB,WAAY,CACR,KAAM,CAACQ,EAAAA,QAAQ,IAAKA,EAAAA,QAAQ,MAAOA,EAAAA,QAAQ,QAAQ,EACnD,QAASA,EAAAA,QAAQ,IAAA,CAEzB,CAAC,EACKC,EAAkBC,GACpB,IAAIC,EAAAA,WACA,CAACC,EAAUC,IAAmB,CAC1B,MAAMC,EAAO,IAAI,WACbC,EAAAA,cAAcH,EAAK,EAAG,OAAOC,CAAM,CAAC,EAAE,MAAA,EACtC,EACA,OAAOA,CAAM,CAAA,EAEjBH,EAAGI,CAAI,CACX,EACA,CACI,QAASN,EAAAA,QAAQ,KACjB,KAAM,CAACA,EAAAA,QAAQ,IAAKA,EAAAA,QAAQ,KAAK,CAAA,CAEzC,EAAE,IACOQ,EAAYC,EAAAA,UAAU,CAACC,EAAQL,EAAQH,IACzCL,EAAWO,EAAAA,IAAIM,CAAM,EAAGL,EAAQH,CAAE,EAC1CD,CAAc"}