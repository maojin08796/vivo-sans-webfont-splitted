{"version":3,"file":"index.js","sources":["../../src/node/index.ts"],"sourcesContent":["import path from 'path';\nimport { FontSplitProps } from '../interface.js';\nimport { getBinName, matchPlatform } from '../load.js';\nimport { isMusl } from './isMusl.js';\nexport * from '../interface.js';\nexport * from '../createAPI.js';\n// @ts-ignore\nimport { dlopen, Callback } from '@xan105/ffi/koffi';\nimport koffi from 'koffi';\nimport { fileURLToPath } from 'url';\nimport { dirname } from 'path';\nimport { createAPI } from '../createAPI.js';\n\n// @ts-ignore 获取当前模块的 URL\nconst __filename = fileURLToPath(import.meta.url);\n\n// 获取当前模块所在的目录\nconst __dirname = dirname(__filename);\n\nlet binPath = process.env.CN_FONT_SPLIT_BIN;\nif (!binPath) {\n    binPath = path.resolve(\n        __dirname,\n        '../' +\n            getBinName(matchPlatform(process.platform, process.arch, isMusl)),\n    );\n    // throw new Error('CN_FONT_SPLIT_BIN is undefined!');\n}\nconst dylib = dlopen(binPath, {\n    font_split: {\n        parameters: ['pointer', 'usize', 'function'],\n        result: 'void',\n    },\n});\nconst createCallback = (cb: (data: Uint8Array) => void) =>\n    new Callback(\n        {\n            parameters: ['pointer', 'usize'],\n            result: 'void',\n        },\n        (ptr: any, length: number) => {\n            const data = koffi.decode(\n                ptr,\n                koffi.array('uint8_t', length, 'Array'),\n            );\n            cb(new Uint8Array(data));\n        },\n    ).pointer;\n\nexport const fontSplit = createAPI(dylib.font_split, createCallback);\n"],"names":["__filename","fileURLToPath","__dirname","dirname","binPath","path","getBinName","matchPlatform","isMusl","dylib","dlopen","createCallback","cb","Callback","ptr","length","data","koffi","fontSplit","createAPI"],"mappings":"6pBAcA,MAAMA,EAAaC,EAAAA,4KAA6B,EAG1CC,EAAYC,EAAAA,QAAQH,CAAU,EAEpC,IAAII,EAAU,QAAQ,IAAI,kBACrBA,IACDA,EAAUC,EAAK,QACXH,EACA,MACII,EAAAA,WAAWC,gBAAc,QAAQ,SAAU,QAAQ,KAAMC,QAAM,CAAC,CAAA,GAI5E,MAAMC,EAAQC,EAAAA,OAAON,EAAS,CAC1B,WAAY,CACR,WAAY,CAAC,UAAW,QAAS,UAAU,EAC3C,OAAQ,MAAA,CAEhB,CAAC,EACKO,EAAkBC,GACpB,IAAIC,EAAAA,SACA,CACI,WAAY,CAAC,UAAW,OAAO,EAC/B,OAAQ,MAAA,EAEZ,CAACC,EAAUC,IAAmB,CAC1B,MAAMC,EAAOC,EAAM,OACfH,EACAG,EAAM,MAAM,UAAWF,EAAQ,OAAO,CAAA,EAE1CH,EAAG,IAAI,WAAWI,CAAI,CAAC,CAC3B,CACJ,EAAE,QAEOE,EAAYC,EAAAA,UAAUV,EAAM,WAAYE,CAAc"}