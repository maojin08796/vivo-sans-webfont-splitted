{"version":3,"file":"createAPI.js","sources":["../src/createAPI.ts"],"sourcesContent":["import { api_interface } from './gen/index';\nimport { FontSplitProps, OriginInput } from './interface';\nexport * from './decodeReporter';\nimport fs from 'fs-extra';\nimport path from 'path';\nexport { api_interface as proto };\n/** 转换 JS 接口数据为 proto 接口数据 */\nconst transType = async (props: FontSplitProps): Promise<OriginInput> => {\n    const data: Partial<OriginInput> = {};\n    if (typeof props.input === 'string') {\n        data.input = await fs.readFile(props.input);\n    } else {\n        data.input = props.input;\n    }\n    if (Array.isArray(props.subsets)) {\n        data.subsets = props.subsets.map(\n            (i) => new Uint8Array(new Uint32Array(i).buffer),\n        );\n    }\n    return { ...props, ...data } as any as OriginInput;\n};\nexport const createAPI = <\n    OriginCB extends (buffer: any, length: number) => void,\n>(\n    font_split: (buffer: Uint8Array, length: number, cb: OriginCB) => void,\n    createCallback: (cb: (data: Uint8Array) => void) => OriginCB,\n    finallyFn?: () => void,\n) => {\n    return async function fontSplit(config: FontSplitProps) {\n        const midType = await transType(config);\n        const input = api_interface.InputTemplate.fromObject(midType);\n        if (!input.outDir) throw new Error('cn-font-split need outDir');\n        const key = Math.random().toString().slice(2, 5);\n        console.time('cn-font-split ' + key);\n        let handles: Promise<void>[] = [];\n        return new Promise<void>((res) => {\n            const buf = input.serialize();\n            const appCallback = (data: Uint8Array): void => {\n                let e = api_interface.EventMessage.deserialize(data);\n                switch (e.event) {\n                    case api_interface.EventName.END:\n                        res();\n                        break;\n                    case api_interface.EventName.OUTPUT_DATA:\n                        !config.silent && console.log(e.message);\n                        let handle = (config.outputFile || fs.outputFile)(\n                            path.join(input.outDir, e.message),\n                            e.data,\n                        );\n                        handles.push(handle);\n                        break;\n                    default:\n                    // console.log(e.event);\n                }\n            };\n            font_split(buf as any, buf.length, createCallback(appCallback));\n        })\n            .then(async (res) => {\n                await Promise.all(handles);\n                return res;\n            })\n            .finally(() => {\n                console.timeEnd('cn-font-split ' + key);\n                finallyFn?.();\n            });\n    };\n};\n"],"names":["transType","props","data","fs","i","createAPI","font_split","createCallback","finallyFn","config","midType","input","api_interface","key","handles","res","buf","appCallback","e","handle","path"],"mappings":"0JAOMA,EAAY,MAAOC,GAAgD,CACrE,MAAMC,EAA6B,CAAA,EACnC,OAAI,OAAOD,EAAM,OAAU,SACvBC,EAAK,MAAQ,MAAMC,EAAG,SAASF,EAAM,KAAK,EAE1CC,EAAK,MAAQD,EAAM,MAEnB,MAAM,QAAQA,EAAM,OAAO,IAC3BC,EAAK,QAAUD,EAAM,QAAQ,IACxBG,GAAM,IAAI,WAAW,IAAI,YAAYA,CAAC,EAAE,MAAM,CAAA,GAGhD,CAAE,GAAGH,EAAO,GAAGC,CAAA,CAC1B,EACaG,EAAY,CAGrBC,EACAC,EACAC,IAEO,eAAyBC,EAAwB,CACpD,MAAMC,EAAU,MAAMV,EAAUS,CAAM,EAChCE,EAAQC,EAAAA,cAAc,cAAc,WAAWF,CAAO,EAC5D,GAAI,CAACC,EAAM,OAAQ,MAAM,IAAI,MAAM,2BAA2B,EAC9D,MAAME,EAAM,KAAK,OAAA,EAAS,WAAW,MAAM,EAAG,CAAC,EAC/C,QAAQ,KAAK,iBAAmBA,CAAG,EACnC,IAAIC,EAA2B,CAAA,EAC/B,OAAO,IAAI,QAAeC,GAAQ,CAC9B,MAAMC,EAAML,EAAM,UAAA,EACZM,EAAef,GAA2B,CAC5C,IAAIgB,EAAIN,EAAAA,cAAc,aAAa,YAAYV,CAAI,EACnD,OAAQgB,EAAE,MAAA,CACN,KAAKN,EAAAA,cAAc,UAAU,IACzBG,EAAA,EACA,MACJ,KAAKH,EAAAA,cAAc,UAAU,YACzB,CAACH,EAAO,QAAU,QAAQ,IAAIS,EAAE,OAAO,EACvC,IAAIC,GAAUV,EAAO,YAAcN,EAAG,YAClCiB,EAAK,KAAKT,EAAM,OAAQO,EAAE,OAAO,EACjCA,EAAE,IAAA,EAENJ,EAAQ,KAAKK,CAAM,EACnB,KACJ,CAGR,EACAb,EAAWU,EAAYA,EAAI,OAAQT,EAAeU,CAAW,CAAC,CAClE,CAAC,EACI,KAAK,MAAOF,IACT,MAAM,QAAQ,IAAID,CAAO,EAClBC,EACV,EACA,QAAQ,IAAM,CACX,QAAQ,QAAQ,iBAAmBF,CAAG,EACtCL,IAAA,CACJ,CAAC,CACT"}