{"version":3,"file":"open.js","sources":["../../../../../../../../../../../node_modules/.pnpm/@xan105+ffi@1.3.0_koffi@2.10.0/node_modules/@xan105/ffi/lib/koffi/open.js"],"sourcesContent":["/*\nCopyright (c) Anthony Beaumont\nThis source code is licensed under the MIT License\nfound in the LICENSE file in the root directory of this source tree.\n*/\n\nimport { platform } from \"node:process\";\nimport { promisify } from \"node:util\";\nimport koffi from \"koffi\";\nimport { Failure, attemptify } from \"@xan105/error\";\nimport { asBoolean, asArray, asStringLike } from \"@xan105/is/opt\";\nimport { \n  shouldObj, \n  shouldObjWithinObj,\n  shouldStringNotEmpty\n} from \"@xan105/is/assert\";\nimport { conventions } from \"./util/abi.js\";\nimport { hashFileSync } from \"../util.js\";\n\nfunction load(path, option = {}){\n  \n  shouldStringNotEmpty(path);\n  shouldObj(option);\n\n  const options = {\n    ignoreLoadingFail: asBoolean(option.ignoreLoadingFail) ?? false,\n    ignoreMissingSymbol: asBoolean(option.ignoreMissingSymbol) ?? false,\n    lazy: asBoolean(option.lazy) ?? false,\n    global: asBoolean(option.global) ?? false, \n    abi: conventions.includes(option.abi) ? option.abi : \"cdecl\",\n    integrity: asStringLike(option.integrity, \"SRI\") ?? \"\"\n  };\n\n  const ext = {\n    \"win32\": \".dll\",\n    \"darwin\": \".dylib\",\n  }[platform] ?? \".so\";\n  \n  if (!path.endsWith(ext)) path += ext;\n\n  //sri\n  if(options.integrity){\n    const [ algo, expected ] = options.integrity.split(\"-\");\n    const [ hash = \"\" ] = attemptify(hashFileSync)(path, algo);\n    if(hash !== expected){\n      throw new Failure(\"Integrity check failed ! Dylib loading has been aborted.\", {\n        code: \"ERR_INTEGRITY\",\n        info : { path, algo, hash }\n      });\n    }\n  }\n  \n  const [dylib, err] = attemptify(koffi.load)(path, { \n    lazy: options.lazy,\n    global: options.global\n  });\n  \n  const handle = function(symbol, result, parameters){\n    try{\n      if (err) throw err;\n      return dylib.func(\"__\" + options.abi, symbol, result, parameters);\n    }catch(err){\n      if (\n        options.ignoreMissingSymbol && \n        err.message.startsWith(\"Cannot find function\") &&\n        err.message.endsWith(\"in shared library\")\n      ) return undefined;\n      \n      if(!dylib && options.ignoreLoadingFail) return undefined;\n      \n      throw new Failure(err.message, {\n        code: \"ERR_FFI\", \n        cause: err, \n        info: { lib: path, symbol }\n      });\n    }\n  };\n  \n  return handle;\n}\n\nfunction dlopen(path, symbols, option = {}){\n  \n  shouldObjWithinObj(symbols);\n  shouldObj(option);\n  \n  const options = {\n    errorAtRuntime: asBoolean(option.errorAtRuntime) ?? false,\n    nonblocking: asBoolean(option.nonblocking) ?? false,\n    stub: asBoolean(option.stub) ?? false\n  };\n  \n  delete option.errorAtRuntime;\n  delete option.nonblocking;\n  delete option.stub;\n  \n  const lib = Object.create(null);\n  const handle = load(path, option);\n\n  for (const [name, definition] of Object.entries(symbols)){\n    \n    if (name === \"__proto__\") continue; //not allowed\n    \n    const symbol = definition.symbol || name;\n    const result = definition.result || \"void\";\n    const parameters = asArray(definition.parameters) ?? [];\n\n    //override\n    const nonblocking = asBoolean(definition.nonblocking) ?? options.nonblocking;\n    const stub = asBoolean(definition.stub) ?? options.stub;\n\n    const [ fn, err ] = attemptify(handle)(symbol, result, parameters);\n    if(err && options.errorAtRuntime === false ) throw err;\n\n    if(typeof fn === \"function\"){\n      lib[name] = nonblocking ? promisify(fn.async) : fn;\n      delete lib[name].async;\n    }\n    else if(err)\n      lib[name] = nonblocking ? ()=>{ return Promise.reject(err) } : ()=>{ throw err };\n    else if(stub)\n      lib[name] = nonblocking ? ()=>{ return Promise.resolve() } : ()=>{};\n  }\n\n  return lib;\n}\n\nexport { load, dlopen }"],"names":["load","path","option","shouldStringNotEmpty","shouldObj","options","asBoolean","conventions","asStringLike","ext","platform","algo","expected","hash","attemptify","hashFileSync","Failure","dylib","err","koffi","symbol","result","parameters","dlopen","symbols","shouldObjWithinObj","lib","handle","name","definition","asArray","nonblocking","stub","fn","promisify"],"mappings":"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","x_google_ignoreList":[0]}