{"version":3,"file":"helper.mjs","sources":["../../../../../../../../../../../node_modules/.pnpm/@xan105+ffi@1.3.0_koffi@2.10.0/node_modules/@xan105/ffi/lib/koffi/helper.js"],"sourcesContent":["/*\nCopyright (c) Anthony Beaumont\nThis source code is licensed under the MIT License\nfound in the LICENSE file in the root directory of this source tree.\n*/\n\nimport { Buffer } from \"node:buffer\";\nimport { randomUUID } from \"node:crypto\";\nimport koffi from \"koffi\";\nimport { shouldStringNotEmpty, shouldObj } from \"@xan105/is/assert\";\nimport { asArray, asBoolean } from \"@xan105/is/opt\";\nimport { isWindows, isFunction } from \"@xan105/is\";\nimport { errorLookup } from \"@xan105/error\";\nimport { GetLastError } from \"./util/win32.js\";\nimport { conventions } from \"./util/abi.js\";\n\nclass Callback{\n  \n  #ref = null;\n  #pointer = null;\n  \n  constructor(definition, callback = null){\n\n    shouldObj(definition);\n    const parameters = asArray(definition.parameters) ?? [];\n    const result = definition.result || \"void\";\n    const abi = conventions.includes(definition.abi) ? definition.abi : \"cdecl\";\n    \n    const cb = koffi.proto(\"__\" + abi, randomUUID(), result, parameters);\n    this.#ref = koffi.pointer(cb);\n\n    if(isFunction(callback)) this.register(callback);\n  }\n  \n  register(callback = ()=>{}){\n    if(this.#ref && this.#pointer) this.close();\n    this.#pointer = koffi.register(callback, this.#ref);\n  }\n  \n  get type(){\n    return this.#ref;\n  }\n  \n  get pointer(){\n    return this.#pointer;\n  }\n  \n  get address(){\n    if(!this.#pointer) return null;\n    return koffi.address(this.#pointer);\n  }\n  \n  close(){\n    if(this.#pointer) koffi.unregister(this.#pointer);\n    this.#pointer = null;\n    this.#ref = null;\n  }\n}\n\nfunction pointer(value, direction = \"in\"){\n  \n  shouldStringNotEmpty(direction);\n  \n  const ptr = koffi.pointer(value);\n\n  switch(direction){\n    case \"out\":\n      return koffi.out(ptr);\n    case \"inout\":\n      return koffi.inout(ptr);\n    default:\n      return ptr\n  }\n}\n\nfunction struct(schema){\n  return koffi.struct(schema);\n}\n\nclass Struct{\n\n  #ref = null;\n  #value = {};\n  #members = null;\n  \n  constructor(type){\n    this.#ref = type;\n    this.#members = Object.keys(koffi.introspect(this.#ref).members);\n  }\n\n  get pointer(){\n    return this.#value;\n  }\n\n  set values(object){\n    shouldObj(object);\n    for (const [ name, value ] of Object.entries(object)){ \n      if (this.#members.includes(name)) this.#value[name] = value;\n    } \n  }\n  \n  get values(){\n    //Workaround to mimic ffi-napi output when empty/non-init by FFI lib\n    if(Object.keys(this.#value).length === 0){\n      for (const { name, type } of Object.values(koffi.introspect(this.#ref).members)){\n        this.#value[name] = alloc(type).get();\n      }\n    }\n    return this.#value;\n  }\n}\n\nfunction structEx(schema){\n  shouldObj(schema);\n  return Object.assign(Object.create(null),{\n    type: struct(schema),\n    create: function(){ \n      return new Struct(this.type);\n    }\n  });\n}\n\nfunction alloc(type){\n  return Object.assign(Object.create(null), {\n    pointer: koffi.alloc?.(type, koffi.sizeof(type)) ?? // >= koffi 2.8\n             Buffer.alloc(koffi.sizeof(type)),\n    get: function(){ \n      return koffi.decode(this.pointer, type);\n    }\n  });\n}\n\nfunction lastError(option = {}){\n  const errno = isWindows() ? GetLastError() : koffi.errno();\n  const options = { translate: asBoolean(option?.translate) ?? true };\n  return options.translate ? errorLookup(errno) : errno;\n}\n\nexport { \n  Callback, \n  pointer,\n  struct,\n  structEx,\n  alloc,\n  lastError\n};"],"names":["Callback","#ref","#pointer","definition","callback","shouldObj","parameters","asArray","result","abi","conventions","cb","koffi","randomUUID","isFunction"],"mappings":";;;;;;;;AAgBA,MAAMA,EAAQ;AAAA,EAEZC,KAAO;AAAA,EACPC,KAAW;AAAA,EAEX,YAAYC,GAAYC,IAAW,MAAK;AAEtC,IAAAC,EAAUF,CAAU;AACpB,UAAMG,IAAaC,EAAQJ,EAAW,UAAU,KAAK,CAAA,GAC/CK,IAASL,EAAW,UAAU,QAC9BM,IAAMC,EAAY,SAASP,EAAW,GAAG,IAAIA,EAAW,MAAM,SAE9DQ,IAAKC,EAAM,MAAM,OAAOH,GAAKI,EAAU,GAAIL,GAAQF,CAAU;AACnE,SAAKL,KAAOW,EAAM,QAAQD,CAAE,GAEzBG,EAAWV,CAAQ,KAAG,KAAK,SAASA,CAAQ;AAAA,EACjD;AAAA,EAEA,SAASA,IAAW,MAAI;AAAA,EAAC,GAAE;AACzB,IAAG,KAAKH,MAAQ,KAAKC,MAAU,KAAK,MAAK,GACzC,KAAKA,KAAWU,EAAM,SAASR,GAAU,KAAKH,EAAI;AAAA,EACpD;AAAA,EAEA,IAAI,OAAM;AACR,WAAO,KAAKA;AAAA,EACd;AAAA,EAEA,IAAI,UAAS;AACX,WAAO,KAAKC;AAAA,EACd;AAAA,EAEA,IAAI,UAAS;AACX,WAAI,KAAKA,KACFU,EAAM,QAAQ,KAAKV,EAAQ,IADR;AAAA,EAE5B;AAAA,EAEA,QAAO;AACL,IAAG,KAAKA,MAAUU,EAAM,WAAW,KAAKV,EAAQ,GAChD,KAAKA,KAAW,MAChB,KAAKD,KAAO;AAAA,EACd;AACF;","x_google_ignoreList":[0]}