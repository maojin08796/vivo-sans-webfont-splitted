{"version":3,"file":"open.mjs","sources":["../../../../../../../../../../../node_modules/.pnpm/@xan105+ffi@1.3.0_koffi@2.10.0/node_modules/@xan105/ffi/lib/koffi/open.js"],"sourcesContent":["/*\nCopyright (c) Anthony Beaumont\nThis source code is licensed under the MIT License\nfound in the LICENSE file in the root directory of this source tree.\n*/\n\nimport { platform } from \"node:process\";\nimport { promisify } from \"node:util\";\nimport koffi from \"koffi\";\nimport { Failure, attemptify } from \"@xan105/error\";\nimport { asBoolean, asArray, asStringLike } from \"@xan105/is/opt\";\nimport { \n  shouldObj, \n  shouldObjWithinObj,\n  shouldStringNotEmpty\n} from \"@xan105/is/assert\";\nimport { conventions } from \"./util/abi.js\";\nimport { hashFileSync } from \"../util.js\";\n\nfunction load(path, option = {}){\n  \n  shouldStringNotEmpty(path);\n  shouldObj(option);\n\n  const options = {\n    ignoreLoadingFail: asBoolean(option.ignoreLoadingFail) ?? false,\n    ignoreMissingSymbol: asBoolean(option.ignoreMissingSymbol) ?? false,\n    lazy: asBoolean(option.lazy) ?? false,\n    global: asBoolean(option.global) ?? false, \n    abi: conventions.includes(option.abi) ? option.abi : \"cdecl\",\n    integrity: asStringLike(option.integrity, \"SRI\") ?? \"\"\n  };\n\n  const ext = {\n    \"win32\": \".dll\",\n    \"darwin\": \".dylib\",\n  }[platform] ?? \".so\";\n  \n  if (!path.endsWith(ext)) path += ext;\n\n  //sri\n  if(options.integrity){\n    const [ algo, expected ] = options.integrity.split(\"-\");\n    const [ hash = \"\" ] = attemptify(hashFileSync)(path, algo);\n    if(hash !== expected){\n      throw new Failure(\"Integrity check failed ! Dylib loading has been aborted.\", {\n        code: \"ERR_INTEGRITY\",\n        info : { path, algo, hash }\n      });\n    }\n  }\n  \n  const [dylib, err] = attemptify(koffi.load)(path, { \n    lazy: options.lazy,\n    global: options.global\n  });\n  \n  const handle = function(symbol, result, parameters){\n    try{\n      if (err) throw err;\n      return dylib.func(\"__\" + options.abi, symbol, result, parameters);\n    }catch(err){\n      if (\n        options.ignoreMissingSymbol && \n        err.message.startsWith(\"Cannot find function\") &&\n        err.message.endsWith(\"in shared library\")\n      ) return undefined;\n      \n      if(!dylib && options.ignoreLoadingFail) return undefined;\n      \n      throw new Failure(err.message, {\n        code: \"ERR_FFI\", \n        cause: err, \n        info: { lib: path, symbol }\n      });\n    }\n  };\n  \n  return handle;\n}\n\nfunction dlopen(path, symbols, option = {}){\n  \n  shouldObjWithinObj(symbols);\n  shouldObj(option);\n  \n  const options = {\n    errorAtRuntime: asBoolean(option.errorAtRuntime) ?? false,\n    nonblocking: asBoolean(option.nonblocking) ?? false,\n    stub: asBoolean(option.stub) ?? false\n  };\n  \n  delete option.errorAtRuntime;\n  delete option.nonblocking;\n  delete option.stub;\n  \n  const lib = Object.create(null);\n  const handle = load(path, option);\n\n  for (const [name, definition] of Object.entries(symbols)){\n    \n    if (name === \"__proto__\") continue; //not allowed\n    \n    const symbol = definition.symbol || name;\n    const result = definition.result || \"void\";\n    const parameters = asArray(definition.parameters) ?? [];\n\n    //override\n    const nonblocking = asBoolean(definition.nonblocking) ?? options.nonblocking;\n    const stub = asBoolean(definition.stub) ?? options.stub;\n\n    const [ fn, err ] = attemptify(handle)(symbol, result, parameters);\n    if(err && options.errorAtRuntime === false ) throw err;\n\n    if(typeof fn === \"function\"){\n      lib[name] = nonblocking ? promisify(fn.async) : fn;\n      delete lib[name].async;\n    }\n    else if(err)\n      lib[name] = nonblocking ? ()=>{ return Promise.reject(err) } : ()=>{ throw err };\n    else if(stub)\n      lib[name] = nonblocking ? ()=>{ return Promise.resolve() } : ()=>{};\n  }\n\n  return lib;\n}\n\nexport { load, dlopen }"],"names":["load","path","option","shouldStringNotEmpty","shouldObj","options","asBoolean","conventions","asStringLike","ext","platform","algo","expected","hash","attemptify","hashFileSync","Failure","dylib","err","koffi","symbol","result","parameters","dlopen","symbols","shouldObjWithinObj","lib","handle","name","definition","asArray","nonblocking","stub","fn","promisify"],"mappings":"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","x_google_ignoreList":[0]}