"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const _=require("node:process"),j=require("node:util"),k=require("koffi"),h=require("../../../../../../@xan105_error@1.7.1/node_modules/@xan105/error/lib/failure.js"),y=require("../../../../../../@xan105_error@1.7.1/node_modules/@xan105/error/lib/attempt.js"),w=require("../../../../../../@xan105_is@2.10.1/node_modules/@xan105/is/lib/opt/array.js"),m=require("../../../../../../@xan105_is@2.10.1/node_modules/@xan105/is/lib/assert/type/obj.js"),B=require("../../../../../../@xan105_is@2.10.1/node_modules/@xan105/is/lib/opt/string.js"),o=require("../../../../../../@xan105_is@2.10.1/node_modules/@xan105/is/lib/opt/boolean.js"),S=require("../../../../../../@xan105_is@2.10.1/node_modules/@xan105/is/lib/assert/type/string.js");require("../../../../../../@xan105_is@2.10.1/node_modules/@xan105/is/lib/is/file/binary.js");const F=require("./util/abi.js"),O=require("../util.js");function q(i,n={}){S.shouldStringNotEmpty(i),m.shouldObj(n);const e={ignoreLoadingFail:o.asBoolean(n.ignoreLoadingFail)??!1,ignoreMissingSymbol:o.asBoolean(n.ignoreMissingSymbol)??!1,lazy:o.asBoolean(n.lazy)??!1,global:o.asBoolean(n.global)??!1,abi:F.conventions.includes(n.abi)?n.abi:"cdecl",integrity:B.asStringLike(n.integrity,"SRI")??""},l={win32:".dll",darwin:".dylib"}[_.platform]??".so";if(i.endsWith(l)||(i+=l),e.integrity){const[r,u]=e.integrity.split("-"),[a=""]=y.attemptify(O.hashFileSync)(i,r);if(a!==u)throw new h.Failure("Integrity check failed ! Dylib loading has been aborted.",{code:"ERR_INTEGRITY",info:{path:i,algo:r,hash:a}})}const[t,f]=y.attemptify(k.load)(i,{lazy:e.lazy,global:e.global});return function(r,u,a){try{if(f)throw f;return t.func("__"+e.abi,r,u,a)}catch(c){if(e.ignoreMissingSymbol&&c.message.startsWith("Cannot find function")&&c.message.endsWith("in shared library")||!t&&e.ignoreLoadingFail)return;throw new h.Failure(c.message,{code:"ERR_FFI",cause:c,info:{lib:i,symbol:r}})}}}function A(i,n,e={}){m.shouldObjWithinObj(n),m.shouldObj(e);const l={errorAtRuntime:o.asBoolean(e.errorAtRuntime)??!1,nonblocking:o.asBoolean(e.nonblocking)??!1,stub:o.asBoolean(e.stub)??!1};delete e.errorAtRuntime,delete e.nonblocking,delete e.stub;const t=Object.create(null),f=q(i,e);for(const[s,r]of Object.entries(n)){if(s==="__proto__")continue;const u=r.symbol||s,a=r.result||"void",c=w.asArray(r.parameters)??[],b=o.asBoolean(r.nonblocking)??l.nonblocking,R=o.asBoolean(r.stub)??l.stub,[g,d]=y.attemptify(f)(u,a,c);if(d&&l.errorAtRuntime===!1)throw d;typeof g=="function"?(t[s]=b?j.promisify(g.async):g,delete t[s].async):d?t[s]=b?()=>Promise.reject(d):()=>{throw d}:R&&(t[s]=b?()=>Promise.resolve():()=>{})}return t}exports.dlopen=A;exports.load=q;
//# sourceMappingURL=open.js.map
